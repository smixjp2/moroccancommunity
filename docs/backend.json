{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the MASI Insights platform, primarily for dashboard access control.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user, used for login.",
          "format": "email"
        },
        "hashedPassword": {
          "type": "string",
          "description": "Hashed password of the user. Note: Secure password storage is crucial. Consider using a robust hashing algorithm."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the user."
        },
        "role": {
          "type": "string",
          "description": "Role of the user (e.g., admin, user).  Used for access control."
        }
      },
      "required": [
        "id",
        "email",
        "hashedPassword",
        "firstName",
        "lastName",
        "role"
      ]
    },
    "Course": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Course",
      "type": "object",
      "description": "Represents an investment course offered on the MASI Insights platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Course entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the course."
        },
        "description": {
          "type": "string",
          "description": "Description of the course content."
        },
        "price": {
          "type": "number",
          "description": "Price of the course."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "price"
      ]
    },
    "UserCourse": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserCourse",
      "type": "object",
      "description": "Represents the courses a user has access to.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserCourse entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N UserCourse)"
        },
        "courseId": {
          "type": "string",
          "description": "Reference to Course. (Relationship: Course 1:N UserCourse)"
        },
        "purchaseDate": {
          "type": "string",
          "description": "The date when the user purchased the course.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "courseId",
        "purchaseDate"
      ]
    },
    "ChatRoom": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatRoom",
      "type": "object",
      "description": "Represents a chat room, usually linked to a course.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ChatRoom, often matching the courseId."
        },
        "name": {
          "type": "string",
          "description": "Display name of the chat room."
        },
        "description": {
          "type": "string",
          "description": "A brief description of the chat room's purpose."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "ChatMessage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatMessage",
      "type": "object",
      "description": "Represents a single message within a chat room.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ChatMessage."
        },
        "text": {
          "type": "string",
          "description": "The content of the message."
        },
        "userId": {
          "type": "string",
          "description": "The UID of the user who sent the message."
        },
        "userName": {
          "type": "string",
          "description": "Denormalized first name of the user for display purposes."
        },
        "createdAt": {
          "type": "object",
          "description": "Firestore server timestamp of when the message was created."
        }
      },
      "required": [
        "id",
        "text",
        "userId",
        "userName",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Used for authentication and authorization. The userId parameter is used to enforce ownership in security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/courses/{courseId}",
        "definition": {
          "entityName": "Course",
          "schema": {
            "$ref": "#/backend/entities/Course"
          },
          "description": "Stores course information. Accessible to all users for listing and viewing course details.",
          "params": [
            {
              "name": "courseId",
              "description": "The unique identifier for the course."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/userCourses/{userCourseId}",
        "definition": {
          "entityName": "UserCourse",
          "schema": {
            "$ref": "#/backend/entities/UserCourse"
          },
          "description": "Stores the courses a user has access to. The userId parameter is denormalized to enable Authorization Independence and path-based security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "userCourseId",
              "description": "The unique identifier for the userCourse."
            }
          ]
        }
      },
      {
        "path": "/chatRooms/{chatRoomId}",
        "definition": {
          "entityName": "ChatRoom",
          "schema": {
            "$ref": "#/backend/entities/ChatRoom"
          },
          "description": "Stores information about a chat room. Chat rooms are generally public to read but secured on write.",
          "params": [
            {
              "name": "chatRoomId",
              "description": "The unique identifier for the chat room, often a courseId."
            }
          ]
        }
      },
      {
        "path": "/chatRooms/{chatRoomId}/messages/{messageId}",
        "definition": {
          "entityName": "ChatMessage",
          "schema": {
            "$ref": "#/backend/entities/ChatMessage"
          },
          "description": "Stores individual messages for a given chat room. Access is controlled based on the user's enrollment in the corresponding course.",
          "params": [
            {
              "name": "chatRoomId",
              "description": "The identifier of the parent chat room."
            },
            {
              "name": "messageId",
              "description": "The unique identifier for the message."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore structure prioritizes security and scalability for the MASI Insights platform, focusing on user authentication and access control to courses. It leverages Authorization Independence by avoiding `get()` calls in security rules, ensuring atomic operations. Homogeneous Security Posture is achieved by segregating data with different access requirements into separate collections.\n\n*   **Users**: User data is stored in a dedicated collection, enabling straightforward authentication via email/password using Firebase Authentication and DBAC based authorization using `role` field.\n*   **Courses**: Courses are stored in a dedicated collection, accessible for listing. Course details are public.\n*   **UserCourses**: Grants users access to courses, ensuring users can only access the courses they have purchased. The `userId` is used to secure access via path-based rules to only the current user's courses. A QAP is supported because listing courses is permitted and access to `UserCourse` documents are secured by the `userId`.\n*   **ChatRooms & Messages**: The new chat functionality is built around a `chatRooms` collection. Access to read/write messages in a room is secured by checking if a `userCourse` document exists for that user and course (`chatRoomId` is the `courseId`). This avoids `get()` calls in rules, maintaining Authorization Independence. Denormalizing `userName` on messages improves performance by avoiding extra client-side lookups.\n\nThis design provides a solid foundation for the MASI Insights platform, facilitating secure access control and scalable data management. The denormalization of authorization data within the `UserCourse` documents is critical for ensuring authorization independence and simplifying security rules. This will allow for atomic operations and predictable authorization logic without relying on complex `get()` calls."
  }
}
